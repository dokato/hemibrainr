---
title: "flywire"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{flywire}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

> "We’re Building Something, Here, Detective, We’re Building It From Scratch. All The Pieces Matter."
([Lester, The Wire](https://en.wikipedia.org/wiki/The_Wire))

# Flywire and R

[Flywire](https://ngl.flywire.ai/?local_id=c8c06ea181ad5447b04beacfc4cb1b66) is an open neuron reconstruction environment for the full adult fly brain ( [FAFB](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6063995/) ) EM data set. Unlike this CATMAID, users concatenate volumetric segmentations to build neurons as 3D meshes. The segmentation was produced by the [Seung group](https://seunglab.org/). With the package `hemibrainr` we can read flywire neurons as both meshes and skeletons. Meshes can be read directly from flywire, but skeletons need to be built from these meshes. Our pakackage `fafbseg` can enable users to skeletonise neurons in R (e.g. `fafbseg::skeletor`), wherease `hemibrainr` exists to help users get hold of neuron data and match flywire neurons to [hemibrain](https://neuprint.janelia.org/help/videos?dataset=hemibrain) neurons. 

On the hemibrain [Google team drive](https://support.google.com/a/users/answer/9310156?hl=en) for the [Drosphila Connctomcis Group](https://www.zoo.cam.ac.uk/research/groups/connectomics). If you do not have access to this team drive and would like to use it, to make the most our of `hemibrainr`, please get in contact. You will need top to have access to the drive and have [Google filestream](https://support.google.com/a/answer/7491144?hl=en) mounted. Then you will be able to:

* Read thousands of pre-skeletonised flywire neurons from Google Drive
* Read flywire NBLASTs and NLBLASTs to hemibrain neurons
* Read flywire neurons that are pre-transformed into a variety of brainspaces

Which is all useful stuff.

## Authorisation

To access flywire data directly from [Flywire](https://ngl.flywire.ai/?local_id=c8c06ea181ad5447b04beacfc4cb1b66), you will need to have an account with them and you will need to use your 'secret' associated with that account. Visit https://globalv1.flywire-daf.com/auth/api/v1/refresh_token to get your token. Note that it changes each time you visit this link. Copy it and then:

```{r flywire_set_token, eval = FALSE}
# remotes::install_github("natverse/fafbseg"), if you don't have the package
fafbseg::flywire_set_token("PASTE_TOKEN_HERE")
```

It is best if you have access to the flywire productio node. Otherwise, you can look at just the base segmentation (useful but a lot less useful).

And now, let's test by looking at some few information available through `hemibrainr`:

```{r see.matches, eval = FALSE}
# Load package
library(hemibrainr)

# This is where hemibrainr expects to find data, if not on google drive 
# or when you use the argument local = TRUE
options()$hemibrain_data

# Else, it wants to see it on the mounted team drive, here
options()$Gdrive_hemibrain_data

# See matches, you can do this without hemibrain Google Team Drive access
View(hemibrain_matched)

# Get fresh matches, you cannot do this without access
## You will be prompted to log-in through your browser
hemibrain_matched_new <- hemibrain_matches() 
## NOTE: includes hemibrain<->flywire matches!
```

## Get flywire neurons

With `hemibrainr` you can easily get thousands of skeletons for flywire neurons. These skeletons have been built using [skeletor](https://github.com/schlegelp/skeletor), which is a python module. You can also use it [directly in R](https://github.com/natverse/fafbseg) with `fafbseg::skeletor`. It has been run on thousands of neurons, which have then been stored on Google Drive, at: `hemibrain/flywire_neurons/` as `nat::neuronlistfh` objects. This means that you can. Let's demonstrate:

You might want to look at specific flywire neurons. You could choose them based on the meta data that you can see with `flywire.neurons[,]`. However, you may also want to choose neurons based on a specific location in the data set. You can do this by giving locations to functions in `fafbseg` and turning them into coordinates. You can either give points in nanometers or raw voxel space. Note that the flywire dataset has a different registration than FAFB14 (used in CATMAID and also some other published data sources). 

```{r choose_segmentation, eval = FALSE}
# Let's say we want the ID for a neuron at these voxel coordinates:
pos = matrix(c(165630,24412,3765),ncol=3) # Can be copied
# from the button at the top of flywire https://ngl.flywire.ai/
pos.nm = pos*c(4,4,40) # this is what it would be in nanometers

# Find the flywire ID!
ids = fafbseg::flywire_xyz2id(pos, rawcoords = TRUE)
# OR: ids = fafbseg::flywire_xyz2id(pos.nm, rawcoords = FALSE)

# What if we want to find the flywire ID associated with a neuron
# From FAFBv14, e.g. from the 'walled garden' CATMAID instance?
fafbseg::choose_segmentation("flywire")
# OR: choose_segmentation("flywire-sandbox") for the base segmentation
nx = nat.templatebrains::xform_brain(elmr::dense_core_neurons, ref="FlyWire", sample="FAFB14")
xyz = nat::xyzmatrix(nx)
ids = unique(fafbseg::flywire_xyz2id(xyz[sample(1:nrow(xyz),100),]))
```

## Skeletonise flywire neurons yourself

We can also skeletonise neurons ourselvesu using [skeletor pipeline in R](https://github.com/natverse/fafbseg). This pipeline reads meshes from flywire, contracts them for accurate skeletonisation, and produces a skeletonised mesh. In R, we also try to re-root the neuron at it's estimated soma location.

You will need to install the python modules releate to skeletor to get it to work. Please follow the instructions [here](https://github.com/schlegelp/skeletor) for the python version. [Here](), we provide a guide to get everthing working in R (in short `reticulate` is used to run python code in a specific, stable conda environment we make for R to use).

Once everything is installed, this ought to work:

```{r skeletor, eval = FALSE}
neurons = fafbseg:::skeletor(ids, brain = elmr::FAFB14.surf) # The brain arguments helps
# to re-root the soma
plot3d(neurons) # note, in flywire space
plot3d(nx, col="black", lwd  =2) # note, in flywire space
```

## Add flywire neurons to the Google Drive

If you had to go to the hassle of skeletonising some flywire neurons that were not on the Google Drive, you don't want to have to do this again. To that end, you can add them to the Goolge Drive as so:

```{r flywire_neurons_update, eval = FALSE}
flywire_neurons_update(x = fw.ids, .parallel = TRUE, OmitFailures = TRUE)
# This can take a little while
```

You can also add flywire neurons to precomputed NBLASTs.

```{r flywire_nblast_update, eval = FALSE}
flywire_nblast_update(x = neurons, nblast = "hemibrain-flywire")
```

These functions can take a long time to run. For example, if adding to the hemibrain-flywire NBLAST, all ~25k flywire neurons need to be read in order to calculate the NBLAST. You can also request that your flywire neurons are added to the precomputations we try to make en mass periodically for the Google drive, if you do not need your answer ASAP. You can do this as so:

```{r flywire_request, eval  = FALSE}
flywire_request(request = fw.ids)
# request can also be a neuronlist in FlyWire space (fastest way)
# Or a matrix with x,y,z positions to add directly.
# Otherwise skeletor is called to skeletonsie flywire neurons related
# to the given IDs, and the position of the root
# is added.
```


## Match flywire neurons

The neuron matching pipeline reads neuron skeletons from Google Drive and and displays them. Flywire skeletons are shown in dark grey (their mirrored equivalents in light grey) and potential hemibrain matches in red. This depends also on the precomputed NBLASTs on the hemibrain team drive. For full details, see our `match_making` vignette. 

```{r flywire_matching, eval = FALSE}
# As simple as:
fafb_matching(ids, repository = "fylwire")

# Or if you just want to go after entries flagegd for your User:
fafb_matching(repository = "fylwire")

# See the results of matching
hemibrain_matched_new <- hemibrain_matches() 
```

What if the flywire neuron you want, is not available to match?

For it to be matchable, we need to add the skeleton to google drive and  then add this entry into the NBLAST computation. Those steps were covered above. Because there are a lot of flywire neurons and hemibrain neurons, they are rather slow and cumbersome. For this reason, we also run a ~daily compute of skeletons and NBLASTs and put them on our Google drive. In order to flag a neuron in flywire for skeletonisation and NBLASTing, its coordinates need to be either in the FAFB tab of [em_matching](https://docs.google.com/spreadsheets/d/1OSlDtnR3B1LiB5cwI5x5Ql6LkZd8JOS5bBr-HTi0pOw/edit) or [flywire_interest](https://docs.google.com/spreadsheets/d/1OSlDtnR3B1LiB5cwI5x5Ql6LkZd8JOS5bBr-HTi0pOw/edit). We use XYZ coordinates in flywire raw voxel space, rather than flywire IDs, because the latter frequently change as a consequence of merging and splitting neurons. Flywire is, at the time of writing (pandemic 2020), an active tracing project.

## Manage the Google sheet

Matches between FAFB neurons (both from FAFBv14 CATMAID and flywire) are recorded on our master Google sheet for matching, [em_matching](https://docs.google.com/spreadsheets/d/1OSlDtnR3B1LiB5cwI5x5Ql6LkZd8JOS5bBr-HTi0pOw/edit). See the `match_making` vignette for details. Because flywire IDs change frequently as a consequence of tracing, and because we keep adding new skeletons to our Google drive dump, it is nice to update the master Google sheet for matching every now and then. We also want to make sure that FAFBv14->flywire matches are recapitulated on the 'hemibrain' matches sheet. This can be done as follows, but can take a long time to run to best to leave it over night:

```{r flywire_matching_rewrite, eval = FALSE}
flywire_matching_rewrite() # bring all the flywire information up to date
```
